using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;

using System.Data;
using SPMWebApp.Services;
using System.Text;

namespace SPMWebApp.WebPages.AccessControl
{
    public partial class SuperAdmin : BasePage.BasePage
    {
        SuperAdminService superAdminService;

        protected void Page_Load(object sender, EventArgs e)
        {
            if (!IsPostBack)
            {
                gvSuperAdmin_DataBind();
                ddl_DataBind();
                dl_DataBind();
            }
        }

        private void gvSuperAdmin_DataBind()
        {
            DataSet ds = new DataSet();

            superAdminService = new SuperAdminService(base.dbConnectionStr);

            ds = superAdminService.SuperAdmin_GetByFilters(ddlUserID.SelectedValue, ddlAEGroup.SelectedValue);

            if (ds.Tables["ReturnTable"].Rows[0]["ReturnCode"].ToString().Equals("1"))
            {
                gvSuperAdmin.DataSource = ds.Tables[0];
                gvSuperAdmin.DataBind();
            }
        }

        private void ddl_DataBind()
        {
            DataSet ds = new DataSet();

            superAdminService = new SuperAdminService(base.dbConnectionStr);

            ds = superAdminService.SuperAdmin_Getddl("", "");

            if (ds.Tables["ReturnTable"].Rows[0]["ReturnCode"].ToString().Equals("1"))
            {
                
                //ddlAEGroup.DataSource = ds.Tables["dtAEGroup"];
                //ddlAEGroup.DataBind();
                //ddlAEGroup.Items.Insert(0, new ListItem("-- Select --", ""));

                //ddlUserID.DataSource = ds.Tables["dtUserID"];
                //ddlUserID.DataBind();
                //ddlUserID.Items.Insert(0, new ListItem("-- Select --", ""));

                //ddlAECode.DataSource = ds.Tables["dtAECode"];
                //ddlAECode.DataBind();
                //ddlAECode.Items.Insert(0, new ListItem("-- Select --", ""));
            }
        }

        private void dl_DataBind()
        {
            DataSet ds = new DataSet();

            superAdminService = new SuperAdminService(base.dbConnectionStr);

            ds = superAdminService.SuperAdmin_Getddl("", "");

            if (ds.Tables["ReturnTable"].Rows[0]["ReturnCode"].ToString().Equals("1"))
            {
                dlUserID.DataSource = ds.Tables["dtUserID"];
                dlUserID.DataBind();

                dlAEGroup.DataSource = ds.Tables["dtAEGroup"];
                dlAEGroup.DataBind();
            }
        }

        protected void btnFind_Click(object sender, EventArgs e)
        {
            gvSuperAdmin_DataBind();
        }

        protected void btnInsert_Click(object sender, EventArgs e)
        {
            DataSet ds = new DataSet();

            superAdminService = new SuperAdminService(base.dbConnectionStr);

            ds = superAdminService.SuperAdmin_Insert(ddlUserID.SelectedValue, ddlAEGroup.SelectedValue);

            if (ds.Tables["ReturnTable"].Rows[0]["ReturnCode"].ToString().Equals("1"))
            {
                gvSuperAdmin_DataBind();
            }
            else
            {
                
            }
        }

        protected void btnRemove_Click(object sender, EventArgs e)
        {
            if (Request.Params["chkIDelete"] != null)
            {
                String strSelect = Request.Params["chkIDelete"].ToString();
                String[] val = strSelect.Split(',');

                String UserID;
                String AEGroup;

                DataSet ds = new DataSet();

                for (int i = 0; i < val.Length; i++)
                {
                    UserID = val[i].Split('-')[0].ToString();
                    AEGroup = val[i].Split('-')[1].ToString();

                    superAdminService = new SuperAdminService(base.dbConnectionStr);

                    ds = superAdminService.SuperAdmin_Delete(UserID, AEGroup);

                    if (ds.Tables["ReturnTable"].Rows[0]["ReturnCode"].ToString().Equals("1"))
                    {
                        gvSuperAdmin_DataBind();
                    }
                    else
                    {
                        
                    }
                }
            }
        }

        protected void btnSearchAEGroup_Click(object sender, EventArgs e)
        {
            DataSet ds = new DataSet();

            superAdminService = new SuperAdminService(base.dbConnectionStr);

            ds = superAdminService.SuperAdmin_Getddl(txtUserIDSearch.Text.Trim(), txtSearchAEGroup.Text.Trim());

            if (ds.Tables["ReturnTable"].Rows[0]["ReturnCode"].ToString().Equals("1"))
            {
                dlAEGroup.DataSource = ds.Tables["dtAEGroup"];
                dlAEGroup.DataBind();
            }
        }

        protected void btnUserIDSearch_Click(object sender, EventArgs e)
        {
            DataSet ds = new DataSet();

            superAdminService = new SuperAdminService(base.dbConnectionStr);

            ds = superAdminService.SuperAdmin_Getddl(txtUserIDSearch.Text.Trim(), txtSearchAEGroup.Text.Trim());

            if (ds.Tables["ReturnTable"].Rows[0]["ReturnCode"].ToString().Equals("1"))
            {
                dlUserID.DataSource = ds.Tables["dtUserID"];
                dlUserID.DataBind();
            }

            if (ds.Tables["dtUserID"].Rows.Count == 0)
            {
                labUserIDSearch.Enabled = false;
                chkUserIDSelectAll.Enabled = false;
            }
            else
            {
                labUserIDSearch.Enabled = true;
                chkUserIDSelectAll.Enabled = true;
            }
        }

        protected void dlUserID_PreRender(object sender, EventArgs e)
        {
            ClientScriptManager cs = Page.ClientScript;

            foreach (DataListItem item in dlUserID.Items)
            {
                CheckBox chkUserID = item.FindControl("chkUserID") as CheckBox;
                cs.RegisterArrayDeclaration("chkUserID", String.Concat("'", chkUserID.ClientID, "'"));
            }
        }

        protected void btnSave_Click(object sender, EventArgs e)
        {
            String UserID;
            String AEGroup;
            CheckBox chkUserID;
            CheckBox chkAEGroup;
            DataSet ds;
            StringBuilder sb = new StringBuilder();

            superAdminService = new SuperAdminService(base.dbConnectionStr);

            foreach (DataListItem itemUserID in dlUserID.Items)
            {
                chkUserID = itemUserID.FindControl("chkUserID") as CheckBox;

                if (chkUserID.Checked == true)
                {
                    UserID = (itemUserID.FindControl("labUserID") as Label).Text;

                    foreach (DataListItem itemAEGroup in dlAEGroup.Items)
                    {
                        chkAEGroup = itemAEGroup.FindControl("chkAEGroup") as CheckBox;

                        if (chkAEGroup.Checked == true)
                        {
                            AEGroup = (itemAEGroup.FindControl("labAEGroup") as Label).Text;

                            ds = superAdminService.SuperAdmin_Insert(UserID, AEGroup);

                            if (ds.Tables["ReturnTable"].Rows[0]["ReturnCode"].ToString().Equals("1"))
                            {
                                gvSuperAdmin_DataBind();
                            }
                            else
                            {
                                sb.Append(ds.Tables["ReturnTable"].Rows[0]["ReturnMessage"].ToString() + Environment.NewLine);
                            }
                        }
                    }
                }
            }

            labError.Text = sb.ToString();
        }
    }
}